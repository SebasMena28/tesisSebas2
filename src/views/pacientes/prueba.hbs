<div class="container p-1 mb-5 mt-5">
    <div class="row">
        <div class="col-md-12 mx-auto">

            <div class="card w-100">
                <div class="card-body">
                    <div class="container p-4">
                        <h2 class="title text-center">
                            Nuevo Paciente
                        </h2>
                    </div>
                    <form class="row g-3 needs-validation" action="/pacientes/nuevoPaciente" method="POST" novalidate>

                        <h4 class="text-center">
                            Datos generales del paciente
                        </h4>
                        {{! esta es la seccion de datos del paciente}}
                        <div class="col-md-4 mb-2">
                            <label for="cedula" class="form-label">Cédula</label>
                            <input type="text" name="cedula" class="form-control" id="cedula" required>
                            <div class="valid-feedback" id="mensaje-cedula">
                                ¡Se ve bien!
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="apellidoPaterno" class="form-label">Apellido Paterno</label>
                                    <input type="text" name="apellidoPaterno" class="form-control" id="apellidoPaterno"
                                        required>
                                    <div class="valid-feedback" id="mensaje-ape1">
                                        ¡Se ve bien!
                                    </div>
                                </div>
                            </div>
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="apellidoMaterno" class="form-label">Apellido Materno</label>
                                    <input type="text" name="apellidoMaterno" class="form-control" id="apellidoMaterno"
                                        required>
                                    <div class="valid-feedback" id="mensaje-ape2">
                                        ¡Se ve bien!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="primerNombre" class="form-label">Primer nombre</label>
                                    <input type="text" name="primerNombre" class="form-control" id="primerNombre"
                                        required>
                                    <div class="valid-feedback" id="mensaje-nombre1">
                                        ¡Se ve bien!
                                    </div>
                                </div>
                            </div>
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="segundoNombre" class="form-label">Segundo Nombre</label>
                                    <input type="text" name="segundoNombre" class="form-control" id="segundoNombre"
                                        required>
                                    <div class="valid-feedback" id="mensaje-nombre2">
                                        ¡Se ve bien!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="fechaNacimiento" class="form-label">Fecha de nacimiento</label>
                                    <input type="date" name="fechaNacimiento" class="form-control" id="fechaNacimiento"
                                        required>
                                    <div class="valid-feedback" id="mensaje-fecha">
                                        ¡Se ve bien!
                                    </div>
                                </div>
                            </div>
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="genero" class="form-label">Genero</label>
                                    <select name="genero" class="form-select" id="genero" required>
                                        <option value="Masculino" selected>Masculino</option>
                                        <option value="Femenino">Femenino</option>
                                        <option value="LGBT">LGBT</option>
                                    </select>
                                    <div class="valid-feedback">
                                        ¡Se ve bien!
                                    </div>
                                    <div class="invalid-feedback">
                                        Por favor, revise los datos de este campo.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="estadoCivil" class="form-label">Estado civil</label>
                                    <select name="estadoCivil" class="form-select" id="estadoCivil">
                                        <option value="Soltero" selected>Soltero</option>
                                        <option value="Casado">Casado</option>
                                        <option value="Divorciado">Divorciado</option>
                                        <option value="Viudo">Viudo</option>
                                        <option value="Union Libre">Union Libre</option>
                                    </select>
                                    <div class="valid-feedback">
                                        ¡Se ve bien!
                                    </div>
                                    <div class="invalid-feedback">
                                        Por favor, revise los datos de este campo.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="ocupacion" class="form-label">Ocupación</label>
                                    <input type="text" name="ocupacion" class="form-control" id="ocupacion" required>
                                    <div class="valid-feedback">
                                        ¡Se ve bien!
                                    </div>
                                    <div class="invalid-feedback">
                                        Por favor, revise los datos de este campo.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-2">
                            <label for="religion" class="form-label">Religión</label>
                            <input type="text" name="religion" class="form-control" id="religion" required>
                            <div class="valid-feedback">
                                ¡Se ve bien!
                            </div>
                            <div class="invalid-feedback">
                                Por favor, revise los datos de este campo.
                            </div>
                        </div>

                        <div class="row g-2 mb-2">
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="correo" class="form-label">Correo</label>
                                    <input type="text" name="correo" class="form-control" id="correo" required>
                                    <div class="valid-feedback" id="mensaje-correo">
                                        ¡Se ve bien!
                                    </div>
                                </div>
                            </div>
                            <div class="col-md">
                                <div class="col-md-4">
                                    <label for="telefono" class="form-label">Teléfono</label>
                                    <input type="text" name="telefono" class="form-control" id="telefono" required>
                                    <div class="valid-feedback" id="mensaje-telefono">
                                        ¡Se ve bien!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-md mb-3">
                                <div class="form-group p-3">
                                    <a class="btn btn-warning btn-block w-100" href="/pacientes">
                                        Regresar
                                    </a>
                                </div>
                            </div>
                            <div class="col-md">
                                <div class="form-group p-3">
                                    <div class="col-12">
                                        <button class="btn btn-success w-100" type="submit">Siguiente</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<script>

    const cedula = document.getElementById('cedula');
    const primerNombre = document.getElementById('primerNombre');
    const segundoNombre = document.getElementById('segundoNombre');
    const apellidoPaterno = document.getElementById('apellidoPaterno');
    const apellidoMaterno = document.getElementById('apellidoMaterno');
    const fechaNacimiento = document.getElementById('fechaNacimiento');
    const correo = document.getElementById('correo');
    const telefono = document.getElementById('telefono');

    const objeto = {
        cedula: cedula,
        primerNombre: primerNombre,
        segundoNombre: segundoNombre,
        apellidoPaterno: apellidoPaterno,
        apellidoMaterno: apellidoMaterno,
        fechaNacimiento: fechaNacimiento,
        correo: correo,
        telefono: telefono
    };

    let atributos = Object.keys(objeto);
    let elementos = Object.values(objeto);
    let datos = {
        cedula: objeto.cedula.value,
        primerNombre: objeto.primerNombre.value,
        segundoNombre: objeto.segundoNombre.value,
        apellidoPaterno: objeto.apellidoPaterno.value,
        apellidoMaterno: objeto.apellidoMaterno.value,
        fechaNacimiento: objeto.fechaNacimiento.value,
        correo: objeto.correo.value,
        telefono: objeto.telefono.value
    };

    ///FUNCIONES PARA VALIDAR CAMPOS
    function validarCedula(cedula) {
        if (cedula.length == 10) {

            //Obtenemos el digito de la region que sonlos dos primeros digitos
            var digito_region = cedula.substring(0, 2);

            //Pregunto si la region existe ecuador se divide en 24 regiones
            if (digito_region >= 1 && digito_region <= 24) {

                // Extraigo el ultimo digito
                var ultimo_digito = cedula.substring(9, 10);

                //Agrupo todos los pares y los sumo
                var pares = parseInt(cedula.substring(1, 2)) + parseInt(cedula.substring(3, 4)) + parseInt(cedula.substring(5, 6)) + parseInt(cedula.substring(7, 8));

                //Agrupo los impares, los multiplico por un factor de 2, si la resultante es > que 9 le restamos el 9 a la resultante
                var numero1 = cedula.substring(0, 1);
                var numero1 = (numero1 * 2);
                if (numero1 > 9) { var numero1 = (numero1 - 9); }

                var numero3 = cedula.substring(2, 3);
                var numero3 = (numero3 * 2);
                if (numero3 > 9) { var numero3 = (numero3 - 9); }

                var numero5 = cedula.substring(4, 5);
                var numero5 = (numero5 * 2);
                if (numero5 > 9) { var numero5 = (numero5 - 9); }

                var numero7 = cedula.substring(6, 7);
                var numero7 = (numero7 * 2);
                if (numero7 > 9) { var numero7 = (numero7 - 9); }

                var numero9 = cedula.substring(8, 9);
                var numero9 = (numero9 * 2);
                if (numero9 > 9) { var numero9 = (numero9 - 9); }

                var impares = numero1 + numero3 + numero5 + numero7 + numero9;

                //Suma total
                var suma_total = (pares + impares);

                //extraemos el primero digito
                var primer_digito_suma = String(suma_total).substring(0, 1);

                //Obtenemos la decena inmediata
                var decena = (parseInt(primer_digito_suma) + 1) * 10;

                //Obtenemos la resta de la decena inmediata - la suma_total esto nos da el digito validador
                var digito_validador = decena - suma_total;

                //Si el digito validador es = a 10 toma el valor de 0
                if (digito_validador == 10)
                    var digito_validador = 0;

                //Validamos que el digito validador sea igual al de la cedula
                if (digito_validador == ultimo_digito) {
                    return true;
                } else {
                    error += 'la cedula:' + cedula + ' es incorrecta ';
                    return false;
                }

            } else {
                //si la region no pertenece
                error += 'Esta cedula no pertenece a ninguna region ';
                return false;
            }
        } else {
            //i la cedula tiene mas o menos de 10 digitos
            error += 'Esta cedula tiene menos de 10 Digitos ';
            return false;
        }
    }



    function validarNombre1(nombre) {
        if (/^[a-zA-ZÀ-ÿ\s]{1,40}$/.test(nombre) && nombre != "" && nombre.length > 1) {
            return true;
        }
        else {
            if (nombre == "") {
                error += 'El primer nombre no puede quedar vacio. \n';
            }
            else if (nombre.length < 2) {
                error += 'El primer nombre no puede ser ' + nombre + '. Se necesita una longitud mayor a un caracter. \n'
            }
            else {
                error += 'El primer nombre no puede ser ' + nombre + '. \n'
            }
            return false;
        }
    }

    function validarNombre2(nombre) {
        if (/^[a-zA-ZÀ-ÿ\s]{1,40}$/.test(nombre) && nombre != "" && nombre.length > 1) {
            return true;
        }
        else {
            if (nombre == "") {
                error += 'El segundo nombre no puede quedar vacio. \n';
            }
            else if (nombre.length < 2) {
                error += 'El segundo nombre no puede ser ' + nombre + '. Se necesita una longitud mayor a un caracter. \n'
            }
            else {
                error += 'El segundo nombre no puede ser ' + nombre + '. \n'
            }
            return false;
        }
    }

    function validarApe1(nombre) {
        if (/^[a-zA-ZÀ-ÿ\s]{1,40}$/.test(nombre) && nombre != "" && nombre.length > 1) {
            return true;
        }
        else {
            if (nombre == "") {
                error += 'El apellido paterno no puede quedar vacio. \n';
            }
            else if (nombre.length < 2) {
                error += 'El apellido paterno no puede ser ' + nombre + '. Se necesita una longitud mayor a un caracter. \n'
            }
            else {
                error += 'El apellido paterno no puede ser ' + nombre + '. \n'
            }
            return false;
        }
    }

    function validarApe2(nombre) {
        if (/^[a-zA-ZÀ-ÿ\s]{1,40}$/.test(nombre) && nombre != "" && nombre.length > 1) {
            return true;
        }
        else {
            if (nombre == "") {
                error += 'El apellido materno no puede quedar vacio. \n';
            }
            else if (nombre.length < 2) {
                error += 'El apellido materno no puede ser ' + nombre + '. Se necesita una longitud mayor a un caracter. \n'
            }
            else {
                error += 'El apellido materno no puede ser ' + nombre + '. \n'
            }
            return false;
        }
    }

    function validarEmail(email) {
        if (/^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/.test(email) && email != "") {
            return true;
        }
        else {
            if (email == "") {
                error += 'El correo no puede quedar vacio. \n';
            }
            else {
                error += 'El correo no puede ser ' + email + '. \n'
            }
            return false;
        }
    }

    function calcularEdad(fecha) {
    var hoy = new Date();
    var cumpleanos = new Date(fecha);
    var edad = hoy.getFullYear() - cumpleanos.getFullYear();
    var m = hoy.getMonth() - cumpleanos.getMonth();

    if (m < 0 || (m === 0 && hoy.getDate() < cumpleanos.getDate())) {
        edad--;
    }

    return edad;
}

    function validarFecha(fecha) {
        const edad = calcularEdad(fecha);
        return edad >= 2 && edad <= 110;
    }

    function validarTelefono(telefono) {
        if (!(/^\d{9}$/.test(telefono)) && telefono.length == 10) {
            return true;
        }
        else {
            error += 'El telefono no es válido'
            return false;
        }
    }

    function enviarMensaje() {
        return error;
    }

    function validaciones(atributo) {
        let pasa = true;
        error = '';
        switch (atributo) {
            case 'cedula':
                pasa = validarCedula(objeto.cedula.value);
                if (!pasa) {
                    document.getElementById('mensaje-cedula').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-cedula').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-cedula').innerHTML = 'La cédula no es válida. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-cedula').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-cedula').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-cedula').innerHTML = 'Completado!';
                }
                console.log('La cedula es: ' + objeto.cedula.value + ' ' + pasa);
                break;
            case 'apellidoPaterno':
                pasa = validarApe1(objeto.apellidoPaterno.value);
                if (!pasa) {
                    document.getElementById('mensaje-ape1').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-ape1').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-ape1').innerHTML = 'Apellido paterno inválido. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-ape1').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-ape1').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-ape1').innerHTML = 'Completado!';
                }
                console.log('apellidoPaterno es: ' + objeto.apellidoPaterno.value + ' ' + pasa);
                break;
            case 'apellidoMaterno':
                pasa = validarApe2(objeto.apellidoMaterno.value);
                if (!pasa) {
                    document.getElementById('mensaje-ape2').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-ape2').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-ape2').innerHTML = 'Apellido materno inválido. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-ape2').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-ape2').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-ape2').innerHTML = 'Completado!';
                }
                console.log('apellidoMaterno es: ' + objeto.apellidoMaterno.value + ' ' + pasa);
                break;
            case 'primerNombre':
                pasa = validarNombre1(objeto.primerNombre.value);
                if (!pasa) {
                    document.getElementById('mensaje-nombre1').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-nombre1').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-nombre1').innerHTML = 'Primer nombre inválido. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-nombre1').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-nombre1').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-nombre1').innerHTML = 'Completado!';
                }
                console.log('primerNombre es: ' + objeto.primerNombre.value + ' ' + pasa);
                break;
            case 'segundoNombre':
                pasa = validarNombre2(objeto.segundoNombre.value);
                if (!pasa) {
                    document.getElementById('mensaje-nombre2').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-nombre2').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-nombre2').innerHTML = 'Segundo nombre inválido. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-nombre2').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-nombre2').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-nombre2').innerHTML = 'Completado!';
                }
                console.log('segundoNombre es: ' + objeto.segundoNombre.value + ' ' + pasa);
                break;
            case 'fechaNacimiento':
                pasa = validarFecha(objeto.fechaNacimiento.value, error);
                if (!pasa) {
                    document.getElementById('mensaje-fecha').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-fecha').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-fecha').innerHTML = 'La fecha de nacimiento no es válida. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-fecha').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-fecha').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-fecha').innerHTML = 'Completado!';
                }
                console.log('fechanacimiento es: ' + objeto.fechaNacimiento.value + ' ' + pasa);
                break;
            case 'correo':
                pasa = validarEmail(objeto.correo.value, error);
                if (!pasa) {
                    document.getElementById('mensaje-correo').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-correo').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-correo').innerHTML = 'El correo no es válido. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-correo').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-correo').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-correo').innerHTML = 'Completado!';
                }
                console.log('correo es: ' + objeto.correo.value + ' ' + pasa);
                break;
            case 'telefono':
                pasa = validarTelefono(objeto.telefono.value, error);
                if (!pasa) {
                    document.getElementById('mensaje-telefono').classList.remove('mensaje-exito-activo')
                    document.getElementById('mensaje-telefono').classList.add('mensaje-error-activo')
                    document.getElementById('mensaje-telefono').innerHTML = 'El teléfono celular no es aceptado. Intente de nuevo';
                }
                else {
                    document.getElementById('mensaje-telefono').classList.remove('mensaje-error-activo')
                    document.getElementById('mensaje-telefono').classList.add('mensaje-exito-activo')
                    document.getElementById('mensaje-telefono').innerHTML = 'Completado!';
                }
                console.log('telefono es: ' + objeto.telefono.value + ' ' + pasa);
                break;
        }
        return pasa;
    };

    function validarDatos(objeto) {
        let atributos = Object.keys(objeto);
        let aprovado = false;
        let confirmado = true;

        for (let i = 0; i < atributos.length; i++) {
            aprovado = validaciones(atributos[i]);
            //console.log(atributos[i], datos[i], aprovado);
            if (!aprovado) confirmado = aprovado;
        }
        //console.log(atributos.length, datos.length);

        return confirmado;
    };

    // Ejemplo de JavaScript inicial para deshabilitar el envío de formularios si hay campos no válidos
    (function () {
        'use strict'

        // Obtener todos los formularios a los que queremos aplicar estilos de validación de Bootstrap personalizados
        var forms = document.querySelectorAll('.needs-validation')

        // Bucle sobre ellos y evitar el envío
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!validarDatos(objeto)) {
                        event.preventDefault();
                        event.stopPropagation();
                    } else {
                        form.submit();
                    }

                    form.classList.add('was-validated')
                }, false)
            })
    })()
</script>

<style>
    body {
        /*background-image: url(https://www.universidades.com.ec/img/article/que-cantidad-de-psicologos-hay-en-ecuador);*/
        background-color: #6495ed;
        /* Fijar la imagen de fondo este vertical y
    horizontalmente y centrado */
        background-position: center center;

        /* Esta imagen no debe de repetirse */
        background-repeat: no-repeat;

        /* COn esta regla fijamos la imagen en la pantalla. */
        background-attachment: fixed;

        /* La imagen ocupa el 100% y se reescala */
        background-size: cover;
    }

    .card {
        border: solid 1px;
        border-radius: 15px;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #111111bd;
        display: flex;
        opacity: 0;
        pointer-events: none;
    }

    .mensaje-error-activo {
        display: block;
        color: rgb(213, 30, 14);
    }

    .mensaje-exito-activo {
        display: block;
        color: rgb(14, 156, 90);
    }

    .mensaje-error-desactivo {
        display: none;
    }

    .mensaje-exito-desactivo {
        display: none;
    }

    .modal--show {
        opacity: 1;
        pointer-events: unset;
    }

    .modal_container {
        width: 90%;
        max-width: 600px;
        max-height: 90%;
        background-color: #fff;
        margin: auto;
        border-radius: 6px;
        padding: 3em 2.5em;
        display: grid;
        gap: 1em;
        place-items: center;
        grid-auto-columns: 100%;
    }

    .form-control {
        width: 290%;
    }

    .form-select {
        width: 290%;
    }

    .title {
        font-size: 2.5rem;
    }

    .text {
        margin-bottom: 10px;
    }

    .image {
        width: 70%;
        max-width: 200px;
    }

    .modal_close {
        text-decoration: none;
        color: #fff;
        background-color: #f26250;
        padding: 1em 3em;
        border: 1px solid;
        border-radius: 6px;
        display: inline-block;
        font-weight: 300;
        transition: background-color 0.3s;
    }

    .modal_close:hover {
        color: #f26250;
        background-color: #fff;
    }
</style>